## How to add new mails on the backend :

To add emails in the backend LinShare you must follow the following steps :

##### 0 -  before you start

Before you begin this task, you must make sure that you have the latest update of the emails on your database, it is required for the next steps.

##### 1 -  Identify the data that will be displayed in the mail

At first, you need to identify the context of the email and the required variables.

    example : Sender, Recipient, Objects ...

##### 2 -  Insert empty email template,

There is some tables in database to store our emails templating. however you need to insert an empty template for all new mails.

Use the script shell `add.new.mails.sh <offset> <count>` to generate the new mail_content and two mail_content_lang for each mail.

You will find this script in the following directory :  `linshare-core/src/main/resources/sql/postgresql`

###### Usage:
    ./add.new.mails.sh <offset> <count>
    first param : offset (the sql id of the last mail content)
                  select id from mail_content order by id desc limit 1;

    second param : count (number of new email to generate)


###### 3 - Activate the email :

For each added email content, we have to add a related mail_action entry. It will allow administrators to enable or disable mail notifications through ui-admin.

###### Usage:

    ./add.new.activations.sh <offset> <policy_id> <names>

    first param : offset (the sql id of the last mail activation)
                  select id from mail_activation order by id desc limit 1;

    second param : policy_id (the sql id of the last policy)
                   select id from policy order by id desc limit 1;

    third param : a list of mail activation identifiers

    ex: ./add.new.activations.sh 16 230 SHARE_WARN_RECIPIENT_ABOUT_EXPIRED_SHARE UPLOAD_REQUEST_ACTIVATED_FOR_OWNER

Important :

* Insert the SQL code generated by the script in LinShare database
* And Add it also to the file `import_common.sql`

##### 5 - Import All changes in database into our local files:

We need to run this script `update_mail_config.sh` located in "linshare-core/utils", to import all our last insertion locally.

For this step, you must do this:

* You have to create this file `update_mail_config.cfg`, and put this:

      #!/bin/bash
      g_host=127.0.0.1
      g_port=5432
      g_database=linshare
      g_user=linshare
      g_pg_dump=/usr/lib/postgresql/9.5/bin/pg_dump

* now you can execute the script

        ############ Config #########
        host : 127.0.0.1
        port : 5432
        database : linshare
        user : linshare
        pg_dump : /usr/lib/postgresql/9.5/bin/pg_dump
        #############################

        Usage : ./update_mail_config.sh <action>
        action = all : automatic mode.
        action = dump : only dump database.
        action = help : display all others actions.

Here are the files they were modified by this script: reset-default-emails-config.sql, import-mails-hibernate3.sql, import-postgresql.sql

##### 6 -  Add the kind of email (Enum) :
It is necessary to add an enum kind for the new mail in java enums :  `MailActivationType` and `MailContentType`.

* Naming convention

[prefix]\_[Subject]

  - [Prefix], example : SHARE, UPDATE, GUEST ...
  - [subject] example : WARN_OWNER_ABOUT_GUEST_EXPIRATION ...

##### 7 - Create the emailContext and EmailBuilder :

You can now create the  `YourNewMailContext`EmailContext   and   `YourNewMailBuilder`EmailBuilder java classes

* EmailContext
* EmailBuilder
    - Create the fakeBuild to test the Email in ui-admin.
    - Create the Build with all the required variables.

##### 8 - Add the mail to the building service and update the geniric test class

* Add your new builder in `MailBuildingServiceImpl`

* Do not forget to update the total number of emails in the geniric email testing class `MailConfigServiceImplTest`.

##### 9 - Write the content of the template

On the ui-admin you need to write the template content, go on left menu, Mails / Mail content, you should find all your new mails Enum, select one and now you can write your template message content by introducing the Subject, Body and your mails in english and french.

Note :
To make default templates, activate these :

Open your linshare.properties file (located on your `configurations/my_conf1` folder) and set to `True` the following variables :

    linshare.notifications.email.templating.override.readonly.mode=true
    linshare.notifications.email.templating.subject.prefix.enable=true

Do not forget to save all your changes and use the preview to test your work.

##### 10 - Run again the script `./update_mail_config.sh all`

##### 11 - Add the trigger of each emails

You must add a trigger to each email, some emails are triggered after an action like (Add, update or delete), others need a batch ...

##### 12 : Add unitTest for the new email
You nedd to test and check your new emails locally. that's why you need to write a test for all your new emails,

Do not forget to start the "wiser" before the test and stop it at the end.
